/*
 * Copyright 2011-2018 Blender Foundation
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

#pragma once

#include "integrator/integrator_state.h"
#include "util/util_color.h"

CCL_NAMESPACE_BEGIN

/* Wavelength to XYZ LUT. Range 360 - 830, step 1. */
ccl_static_constant float wavelength_xyz_lookup[][3] = {
    {0.000129900000f, 0.000003917000f, 0.000606100000f},
    {0.000145847000f, 0.000004393581f, 0.000680879200f},
    {0.000163802100f, 0.000004929604f, 0.000765145600f},
    {0.000184003700f, 0.000005532136f, 0.000860012400f},
    {0.000206690200f, 0.000006208245f, 0.000966592800f},
    {0.000232100000f, 0.000006965000f, 0.001086000000f},
    {0.000260728000f, 0.000007813219f, 0.001220586000f},
    {0.000293075000f, 0.000008767336f, 0.001372729000f},
    {0.000329388000f, 0.000009839844f, 0.001543579000f},
    {0.000369914000f, 0.000011043230f, 0.001734286000f},
    {0.000414900000f, 0.000012390000f, 0.001946000000f},
    {0.000464158700f, 0.000013886410f, 0.002177777000f},
    {0.000518986000f, 0.000015557280f, 0.002435809000f},
    {0.000581854000f, 0.000017442960f, 0.002731953000f},
    {0.000655234700f, 0.000019583750f, 0.003078064000f},
    {0.000741600000f, 0.000022020000f, 0.003486000000f},
    {0.000845029600f, 0.000024839650f, 0.003975227000f},
    {0.000964526800f, 0.000028041260f, 0.004540880000f},
    {0.001094949000f, 0.000031531040f, 0.005158320000f},
    {0.001231154000f, 0.000035215210f, 0.005802907000f},
    {0.001368000000f, 0.000039000000f, 0.006450001000f},
    {0.001502050000f, 0.000042826400f, 0.007083216000f},
    {0.001642328000f, 0.000046914600f, 0.007745488000f},
    {0.001802382000f, 0.000051589600f, 0.008501152000f},
    {0.001995757000f, 0.000057176400f, 0.009414544000f},
    {0.002236000000f, 0.000064000000f, 0.010549990000f},
    {0.002535385000f, 0.000072344210f, 0.011965800000f},
    {0.002892603000f, 0.000082212240f, 0.013655870000f},
    {0.003300829000f, 0.000093508160f, 0.015588050000f},
    {0.003753236000f, 0.000106136100f, 0.017730150000f},
    {0.004243000000f, 0.000120000000f, 0.020050010000f},
    {0.004762389000f, 0.000134984000f, 0.022511360000f},
    {0.005330048000f, 0.000151492000f, 0.025202880000f},
    {0.005978712000f, 0.000170208000f, 0.028279720000f},
    {0.006741117000f, 0.000191816000f, 0.031897040000f},
    {0.007650000000f, 0.000217000000f, 0.036210000000f},
    {0.008751373000f, 0.000246906700f, 0.041437710000f},
    {0.010028880000f, 0.000281240000f, 0.047503720000f},
    {0.011421700000f, 0.000318520000f, 0.054119880000f},
    {0.012869010000f, 0.000357266700f, 0.060998030000f},
    {0.014310000000f, 0.000396000000f, 0.067850010000f},
    {0.015704430000f, 0.000433714700f, 0.074486320000f},
    {0.017147440000f, 0.000473024000f, 0.081361560000f},
    {0.018781220000f, 0.000517876000f, 0.089153640000f},
    {0.020748010000f, 0.000572218700f, 0.098540480000f},
    {0.023190000000f, 0.000640000000f, 0.110200000000f},
    {0.026207360000f, 0.000724560000f, 0.124613300000f},
    {0.029782480000f, 0.000825500000f, 0.141701700000f},
    {0.033880920000f, 0.000941160000f, 0.161303500000f},
    {0.038468240000f, 0.001069880000f, 0.183256800000f},
    {0.043510000000f, 0.001210000000f, 0.207400000000f},
    {0.048995600000f, 0.001362091000f, 0.233692100000f},
    {0.055022600000f, 0.001530752000f, 0.262611400000f},
    {0.061718800000f, 0.001720368000f, 0.294774600000f},
    {0.069212000000f, 0.001935323000f, 0.330798500000f},
    {0.077630000000f, 0.002180000000f, 0.371300000000f},
    {0.086958110000f, 0.002454800000f, 0.416209100000f},
    {0.097176720000f, 0.002764000000f, 0.465464200000f},
    {0.108406300000f, 0.003117800000f, 0.519694800000f},
    {0.120767200000f, 0.003526400000f, 0.579530300000f},
    {0.134380000000f, 0.004000000000f, 0.645600000000f},
    {0.149358200000f, 0.004546240000f, 0.718483800000f},
    {0.165395700000f, 0.005159320000f, 0.796713300000f},
    {0.181983100000f, 0.005829280000f, 0.877845900000f},
    {0.198611000000f, 0.006546160000f, 0.959439000000f},
    {0.214770000000f, 0.007300000000f, 1.039050100000f},
    {0.230186800000f, 0.008086507000f, 1.115367300000f},
    {0.244879700000f, 0.008908720000f, 1.188497100000f},
    {0.258777300000f, 0.009767680000f, 1.258123300000f},
    {0.271807900000f, 0.010664430000f, 1.323929600000f},
    {0.283900000000f, 0.011600000000f, 1.385600000000f},
    {0.294943800000f, 0.012573170000f, 1.442635200000f},
    {0.304896500000f, 0.013582720000f, 1.494803500000f},
    {0.313787300000f, 0.014629680000f, 1.542190300000f},
    {0.321645400000f, 0.015715090000f, 1.584880700000f},
    {0.328500000000f, 0.016840000000f, 1.622960000000f},
    {0.334351300000f, 0.018007360000f, 1.656404800000f},
    {0.339210100000f, 0.019214480000f, 1.685295900000f},
    {0.343121300000f, 0.020453920000f, 1.709874500000f},
    {0.346129600000f, 0.021718240000f, 1.730382100000f},
    {0.348280000000f, 0.023000000000f, 1.747060000000f},
    {0.349599900000f, 0.024294610000f, 1.760044600000f},
    {0.350147400000f, 0.025610240000f, 1.769623300000f},
    {0.350013000000f, 0.026958570000f, 1.776263700000f},
    {0.349287000000f, 0.028351250000f, 1.780433400000f},
    {0.348060000000f, 0.029800000000f, 1.782600000000f},
    {0.346373300000f, 0.031310830000f, 1.782968200000f},
    {0.344262400000f, 0.032883680000f, 1.781699800000f},
    {0.341808800000f, 0.034521120000f, 1.779198200000f},
    {0.339094100000f, 0.036225710000f, 1.775867100000f},
    {0.336200000000f, 0.038000000000f, 1.772110000000f},
    {0.333197700000f, 0.039846670000f, 1.768258900000f},
    {0.330041100000f, 0.041768000000f, 1.764039000000f},
    {0.326635700000f, 0.043766000000f, 1.758943800000f},
    {0.322886800000f, 0.045842670000f, 1.752466300000f},
    {0.318700000000f, 0.048000000000f, 1.744100000000f},
    {0.314025100000f, 0.050243680000f, 1.733559500000f},
    {0.308884000000f, 0.052573040000f, 1.720858100000f},
    {0.303290400000f, 0.054980560000f, 1.705936900000f},
    {0.297257900000f, 0.057458720000f, 1.688737200000f},
    {0.290800000000f, 0.060000000000f, 1.669200000000f},
    {0.283970100000f, 0.062601970000f, 1.647528700000f},
    {0.276721400000f, 0.065277520000f, 1.623412700000f},
    {0.268917800000f, 0.068042080000f, 1.596022300000f},
    {0.260422700000f, 0.070911090000f, 1.564528000000f},
    {0.251100000000f, 0.073900000000f, 1.528100000000f},
    {0.240847500000f, 0.077016000000f, 1.486111400000f},
    {0.229851200000f, 0.080266400000f, 1.439521500000f},
    {0.218407200000f, 0.083666800000f, 1.389879900000f},
    {0.206811500000f, 0.087232800000f, 1.338736200000f},
    {0.195360000000f, 0.090980000000f, 1.287640000000f},
    {0.184213600000f, 0.094917550000f, 1.237422300000f},
    {0.173327300000f, 0.099045840000f, 1.187824300000f},
    {0.162688100000f, 0.103367400000f, 1.138761100000f},
    {0.152283300000f, 0.107884600000f, 1.090148000000f},
    {0.142100000000f, 0.112600000000f, 1.041900000000f},
    {0.132178600000f, 0.117532000000f, 0.994197600000f},
    {0.122569600000f, 0.122674400000f, 0.947347300000f},
    {0.113275200000f, 0.127992800000f, 0.901453100000f},
    {0.104297900000f, 0.133452800000f, 0.856619300000f},
    {0.095640000000f, 0.139020000000f, 0.812950100000f},
    {0.087299550000f, 0.144676400000f, 0.770517300000f},
    {0.079308040000f, 0.150469300000f, 0.729444800000f},
    {0.071717760000f, 0.156461900000f, 0.689913600000f},
    {0.064580990000f, 0.162717700000f, 0.652104900000f},
    {0.057950010000f, 0.169300000000f, 0.616200000000f},
    {0.051862110000f, 0.176243100000f, 0.582328600000f},
    {0.046281520000f, 0.183558100000f, 0.550416200000f},
    {0.041150880000f, 0.191273500000f, 0.520337600000f},
    {0.036412830000f, 0.199418000000f, 0.491967300000f},
    {0.032010000000f, 0.208020000000f, 0.465180000000f},
    {0.027917200000f, 0.217119900000f, 0.439924600000f},
    {0.024144400000f, 0.226734500000f, 0.416183600000f},
    {0.020687000000f, 0.236857100000f, 0.393882200000f},
    {0.017540400000f, 0.247481200000f, 0.372945900000f},
    {0.014700000000f, 0.258600000000f, 0.353300000000f},
    {0.012161790000f, 0.270184900000f, 0.334857800000f},
    {0.009919960000f, 0.282293900000f, 0.317552100000f},
    {0.007967240000f, 0.295050500000f, 0.301337500000f},
    {0.006296346000f, 0.308578000000f, 0.286168600000f},
    {0.004900000000f, 0.323000000000f, 0.272000000000f},
    {0.003777173000f, 0.338402100000f, 0.258817100000f},
    {0.002945320000f, 0.354685800000f, 0.246483800000f},
    {0.002424880000f, 0.371698600000f, 0.234771800000f},
    {0.002236293000f, 0.389287500000f, 0.223453300000f},
    {0.002400000000f, 0.407300000000f, 0.212300000000f},
    {0.002925520000f, 0.425629900000f, 0.201169200000f},
    {0.003836560000f, 0.444309600000f, 0.190119600000f},
    {0.005174840000f, 0.463394400000f, 0.179225400000f},
    {0.006982080000f, 0.482939500000f, 0.168560800000f},
    {0.009300000000f, 0.503000000000f, 0.158200000000f},
    {0.012149490000f, 0.523569300000f, 0.148138300000f},
    {0.015535880000f, 0.544512000000f, 0.138375800000f},
    {0.019477520000f, 0.565690000000f, 0.128994200000f},
    {0.023992770000f, 0.586965300000f, 0.120075100000f},
    {0.029100000000f, 0.608200000000f, 0.111700000000f},
    {0.034814850000f, 0.629345600000f, 0.103904800000f},
    {0.041120160000f, 0.650306800000f, 0.096667480000f},
    {0.047985040000f, 0.670875200000f, 0.089982720000f},
    {0.055378610000f, 0.690842400000f, 0.083845310000f},
    {0.063270000000f, 0.710000000000f, 0.078249990000f},
    {0.071635010000f, 0.728185200000f, 0.073208990000f},
    {0.080462240000f, 0.745463600000f, 0.068678160000f},
    {0.089739960000f, 0.761969400000f, 0.064567840000f},
    {0.099456450000f, 0.777836800000f, 0.060788350000f},
    {0.109600000000f, 0.793200000000f, 0.057250010000f},
    {0.120167400000f, 0.808110400000f, 0.053904350000f},
    {0.131114500000f, 0.822496200000f, 0.050746640000f},
    {0.142367900000f, 0.836306800000f, 0.047752760000f},
    {0.153854200000f, 0.849491600000f, 0.044898590000f},
    {0.165500000000f, 0.862000000000f, 0.042160000000f},
    {0.177257100000f, 0.873810800000f, 0.039507280000f},
    {0.189140000000f, 0.884962400000f, 0.036935640000f},
    {0.201169400000f, 0.895493600000f, 0.034458360000f},
    {0.213365800000f, 0.905443200000f, 0.032088720000f},
    {0.225749900000f, 0.914850100000f, 0.029840000000f},
    {0.238320900000f, 0.923734800000f, 0.027711810000f},
    {0.251066800000f, 0.932092400000f, 0.025694440000f},
    {0.263992200000f, 0.939922600000f, 0.023787160000f},
    {0.277101700000f, 0.947225200000f, 0.021989250000f},
    {0.290400000000f, 0.954000000000f, 0.020300000000f},
    {0.303891200000f, 0.960256100000f, 0.018718050000f},
    {0.317572600000f, 0.966007400000f, 0.017240360000f},
    {0.331438400000f, 0.971260600000f, 0.015863640000f},
    {0.345482800000f, 0.976022500000f, 0.014584610000f},
    {0.359700000000f, 0.980300000000f, 0.013400000000f},
    {0.374083900000f, 0.984092400000f, 0.012307230000f},
    {0.388639600000f, 0.987418200000f, 0.011301880000f},
    {0.403378400000f, 0.990312800000f, 0.010377920000f},
    {0.418311500000f, 0.992811600000f, 0.009529306000f},
    {0.433449900000f, 0.994950100000f, 0.008749999000f},
    {0.448795300000f, 0.996710800000f, 0.008035200000f},
    {0.464336000000f, 0.998098300000f, 0.007381600000f},
    {0.480064000000f, 0.999112000000f, 0.006785400000f},
    {0.495971300000f, 0.999748200000f, 0.006242800000f},
    {0.512050100000f, 1.000000000000f, 0.005749999000f},
    {0.528295900000f, 0.999856700000f, 0.005303600000f},
    {0.544691600000f, 0.999304600000f, 0.004899800000f},
    {0.561209400000f, 0.998325500000f, 0.004534200000f},
    {0.577821500000f, 0.996898700000f, 0.004202400000f},
    {0.594500000000f, 0.995000000000f, 0.003900000000f},
    {0.611220900000f, 0.992600500000f, 0.003623200000f},
    {0.627975800000f, 0.989742600000f, 0.003370600000f},
    {0.644760200000f, 0.986444400000f, 0.003141400000f},
    {0.661569700000f, 0.982724100000f, 0.002934800000f},
    {0.678400000000f, 0.978600000000f, 0.002749999000f},
    {0.695239200000f, 0.974083700000f, 0.002585200000f},
    {0.712058600000f, 0.969171200000f, 0.002438600000f},
    {0.728828400000f, 0.963856800000f, 0.002309400000f},
    {0.745518800000f, 0.958134900000f, 0.002196800000f},
    {0.762100000000f, 0.952000000000f, 0.002100000000f},
    {0.778543200000f, 0.945450400000f, 0.002017733000f},
    {0.794825600000f, 0.938499200000f, 0.001948200000f},
    {0.810926400000f, 0.931162800000f, 0.001889800000f},
    {0.826824800000f, 0.923457600000f, 0.001840933000f},
    {0.842500000000f, 0.915400000000f, 0.001800000000f},
    {0.857932500000f, 0.907006400000f, 0.001766267000f},
    {0.873081600000f, 0.898277200000f, 0.001737800000f},
    {0.887894400000f, 0.889204800000f, 0.001711200000f},
    {0.902318100000f, 0.879781600000f, 0.001683067000f},
    {0.916300000000f, 0.870000000000f, 0.001650001000f},
    {0.929799500000f, 0.859861300000f, 0.001610133000f},
    {0.942798400000f, 0.849392000000f, 0.001564400000f},
    {0.955277600000f, 0.838622000000f, 0.001513600000f},
    {0.967217900000f, 0.827581300000f, 0.001458533000f},
    {0.978600000000f, 0.816300000000f, 0.001400000000f},
    {0.989385600000f, 0.804794700000f, 0.001336667000f},
    {0.999548800000f, 0.793082000000f, 0.001270000000f},
    {1.009089200000f, 0.781192000000f, 0.001205000000f},
    {1.018006400000f, 0.769154700000f, 0.001146667000f},
    {1.026300000000f, 0.757000000000f, 0.001100000000f},
    {1.033982700000f, 0.744754100000f, 0.001068800000f},
    {1.040986000000f, 0.732422400000f, 0.001049400000f},
    {1.047188000000f, 0.720003600000f, 0.001035600000f},
    {1.052466700000f, 0.707496500000f, 0.001021200000f},
    {1.056700000000f, 0.694900000000f, 0.001000000000f},
    {1.059794400000f, 0.682219200000f, 0.000968640000f},
    {1.061799200000f, 0.669471600000f, 0.000929920000f},
    {1.062806800000f, 0.656674400000f, 0.000886880000f},
    {1.062909600000f, 0.643844800000f, 0.000842560000f},
    {1.062200000000f, 0.631000000000f, 0.000800000000f},
    {1.060735200000f, 0.618155500000f, 0.000760960000f},
    {1.058443600000f, 0.605314400000f, 0.000723680000f},
    {1.055224400000f, 0.592475600000f, 0.000685920000f},
    {1.050976800000f, 0.579637900000f, 0.000645440000f},
    {1.045600000000f, 0.566800000000f, 0.000600000000f},
    {1.039036900000f, 0.553961100000f, 0.000547866700f},
    {1.031360800000f, 0.541137200000f, 0.000491600000f},
    {1.022666200000f, 0.528352800000f, 0.000435400000f},
    {1.013047700000f, 0.515632300000f, 0.000383466700f},
    {1.002600000000f, 0.503000000000f, 0.000340000000f},
    {0.991367500000f, 0.490468800000f, 0.000307253300f},
    {0.979331400000f, 0.478030400000f, 0.000283160000f},
    {0.966491600000f, 0.465677600000f, 0.000265440000f},
    {0.952847900000f, 0.453403200000f, 0.000251813300f},
    {0.938400000000f, 0.441200000000f, 0.000240000000f},
    {0.923194000000f, 0.429080000000f, 0.000229546700f},
    {0.907244000000f, 0.417036000000f, 0.000220640000f},
    {0.890502000000f, 0.405032000000f, 0.000211960000f},
    {0.872920000000f, 0.393032000000f, 0.000202186700f},
    {0.854449900000f, 0.381000000000f, 0.000190000000f},
    {0.835084000000f, 0.368918400000f, 0.000174213300f},
    {0.814946000000f, 0.356827200000f, 0.000155640000f},
    {0.794186000000f, 0.344776800000f, 0.000135960000f},
    {0.772954000000f, 0.332817600000f, 0.000116853300f},
    {0.751400000000f, 0.321000000000f, 0.000100000000f},
    {0.729583600000f, 0.309338100000f, 0.000086133330f},
    {0.707588800000f, 0.297850400000f, 0.000074600000f},
    {0.685602200000f, 0.286593600000f, 0.000065000000f},
    {0.663810400000f, 0.275624500000f, 0.000056933330f},
    {0.642400000000f, 0.265000000000f, 0.000049999990f},
    {0.621514900000f, 0.254763200000f, 0.000044160000f},
    {0.601113800000f, 0.244889600000f, 0.000039480000f},
    {0.581105200000f, 0.235334400000f, 0.000035720000f},
    {0.561397700000f, 0.226052800000f, 0.000032640000f},
    {0.541900000000f, 0.217000000000f, 0.000030000000f},
    {0.522599500000f, 0.208161600000f, 0.000027653330f},
    {0.503546400000f, 0.199548800000f, 0.000025560000f},
    {0.484743600000f, 0.191155200000f, 0.000023640000f},
    {0.466193900000f, 0.182974400000f, 0.000021813330f},
    {0.447900000000f, 0.175000000000f, 0.000020000000f},
    {0.429861300000f, 0.167223500000f, 0.000018133330f},
    {0.412098000000f, 0.159646400000f, 0.000016200000f},
    {0.394644000000f, 0.152277600000f, 0.000014200000f},
    {0.377533300000f, 0.145125900000f, 0.000012133330f},
    {0.360800000000f, 0.138200000000f, 0.000010000000f},
    {0.344456300000f, 0.131500300000f, 0.000007733333f},
    {0.328516800000f, 0.125024800000f, 0.000005400000f},
    {0.313019200000f, 0.118779200000f, 0.000003200000f},
    {0.298001100000f, 0.112769100000f, 0.000001333333f},
    {0.283500000000f, 0.107000000000f, 0.000000000000f},
    {0.269544800000f, 0.101476200000f, 0.000000000000f},
    {0.256118400000f, 0.096188640000f, 0.000000000000f},
    {0.243189600000f, 0.091122960000f, 0.000000000000f},
    {0.230727200000f, 0.086264850000f, 0.000000000000f},
    {0.218700000000f, 0.081600000000f, 0.000000000000f},
    {0.207097100000f, 0.077120640000f, 0.000000000000f},
    {0.195923200000f, 0.072825520000f, 0.000000000000f},
    {0.185170800000f, 0.068710080000f, 0.000000000000f},
    {0.174832300000f, 0.064769760000f, 0.000000000000f},
    {0.164900000000f, 0.061000000000f, 0.000000000000f},
    {0.155366700000f, 0.057396210000f, 0.000000000000f},
    {0.146230000000f, 0.053955040000f, 0.000000000000f},
    {0.137490000000f, 0.050673760000f, 0.000000000000f},
    {0.129146700000f, 0.047549650000f, 0.000000000000f},
    {0.121200000000f, 0.044580000000f, 0.000000000000f},
    {0.113639700000f, 0.041758720000f, 0.000000000000f},
    {0.106465000000f, 0.039084960000f, 0.000000000000f},
    {0.099690440000f, 0.036563840000f, 0.000000000000f},
    {0.093330610000f, 0.034200480000f, 0.000000000000f},
    {0.087400000000f, 0.032000000000f, 0.000000000000f},
    {0.081900960000f, 0.029962610000f, 0.000000000000f},
    {0.076804280000f, 0.028076640000f, 0.000000000000f},
    {0.072077120000f, 0.026329360000f, 0.000000000000f},
    {0.067686640000f, 0.024708050000f, 0.000000000000f},
    {0.063600000000f, 0.023200000000f, 0.000000000000f},
    {0.059806850000f, 0.021800770000f, 0.000000000000f},
    {0.056282160000f, 0.020501120000f, 0.000000000000f},
    {0.052971040000f, 0.019281080000f, 0.000000000000f},
    {0.049818610000f, 0.018120690000f, 0.000000000000f},
    {0.046770000000f, 0.017000000000f, 0.000000000000f},
    {0.043784050000f, 0.015903790000f, 0.000000000000f},
    {0.040875360000f, 0.014837180000f, 0.000000000000f},
    {0.038072640000f, 0.013810680000f, 0.000000000000f},
    {0.035404610000f, 0.012834780000f, 0.000000000000f},
    {0.032900000000f, 0.011920000000f, 0.000000000000f},
    {0.030564190000f, 0.011068310000f, 0.000000000000f},
    {0.028380560000f, 0.010273390000f, 0.000000000000f},
    {0.026344840000f, 0.009533311000f, 0.000000000000f},
    {0.024452750000f, 0.008846157000f, 0.000000000000f},
    {0.022700000000f, 0.008210000000f, 0.000000000000f},
    {0.021084290000f, 0.007623781000f, 0.000000000000f},
    {0.019599880000f, 0.007085424000f, 0.000000000000f},
    {0.018237320000f, 0.006591476000f, 0.000000000000f},
    {0.016987170000f, 0.006138485000f, 0.000000000000f},
    {0.015840000000f, 0.005723000000f, 0.000000000000f},
    {0.014790640000f, 0.005343059000f, 0.000000000000f},
    {0.013831320000f, 0.004995796000f, 0.000000000000f},
    {0.012948680000f, 0.004676404000f, 0.000000000000f},
    {0.012129200000f, 0.004380075000f, 0.000000000000f},
    {0.011359160000f, 0.004102000000f, 0.000000000000f},
    {0.010629350000f, 0.003838453000f, 0.000000000000f},
    {0.009938846000f, 0.003589099000f, 0.000000000000f},
    {0.009288422000f, 0.003354219000f, 0.000000000000f},
    {0.008678854000f, 0.003134093000f, 0.000000000000f},
    {0.008110916000f, 0.002929000000f, 0.000000000000f},
    {0.007582388000f, 0.002738139000f, 0.000000000000f},
    {0.007088746000f, 0.002559876000f, 0.000000000000f},
    {0.006627313000f, 0.002393244000f, 0.000000000000f},
    {0.006195408000f, 0.002237275000f, 0.000000000000f},
    {0.005790346000f, 0.002091000000f, 0.000000000000f},
    {0.005409826000f, 0.001953587000f, 0.000000000000f},
    {0.005052583000f, 0.001824580000f, 0.000000000000f},
    {0.004717512000f, 0.001703580000f, 0.000000000000f},
    {0.004403507000f, 0.001590187000f, 0.000000000000f},
    {0.004109457000f, 0.001484000000f, 0.000000000000f},
    {0.003833913000f, 0.001384496000f, 0.000000000000f},
    {0.003575748000f, 0.001291268000f, 0.000000000000f},
    {0.003334342000f, 0.001204092000f, 0.000000000000f},
    {0.003109075000f, 0.001122744000f, 0.000000000000f},
    {0.002899327000f, 0.001047000000f, 0.000000000000f},
    {0.002704348000f, 0.000976589600f, 0.000000000000f},
    {0.002523020000f, 0.000911108800f, 0.000000000000f},
    {0.002354168000f, 0.000850133200f, 0.000000000000f},
    {0.002196616000f, 0.000793238400f, 0.000000000000f},
    {0.002049190000f, 0.000740000000f, 0.000000000000f},
    {0.001910960000f, 0.000690082700f, 0.000000000000f},
    {0.001781438000f, 0.000643310000f, 0.000000000000f},
    {0.001660110000f, 0.000599496000f, 0.000000000000f},
    {0.001546459000f, 0.000558454700f, 0.000000000000f},
    {0.001439971000f, 0.000520000000f, 0.000000000000f},
    {0.001340042000f, 0.000483913600f, 0.000000000000f},
    {0.001246275000f, 0.000450052800f, 0.000000000000f},
    {0.001158471000f, 0.000418345200f, 0.000000000000f},
    {0.001076430000f, 0.000388718400f, 0.000000000000f},
    {0.000999949300f, 0.000361100000f, 0.000000000000f},
    {0.000928735800f, 0.000335383500f, 0.000000000000f},
    {0.000862433200f, 0.000311440400f, 0.000000000000f},
    {0.000800750300f, 0.000289165600f, 0.000000000000f},
    {0.000743396000f, 0.000268453900f, 0.000000000000f},
    {0.000690078600f, 0.000249200000f, 0.000000000000f},
    {0.000640515600f, 0.000231301900f, 0.000000000000f},
    {0.000594502100f, 0.000214685600f, 0.000000000000f},
    {0.000551864600f, 0.000199288400f, 0.000000000000f},
    {0.000512429000f, 0.000185047500f, 0.000000000000f},
    {0.000476021300f, 0.000171900000f, 0.000000000000f},
    {0.000442453600f, 0.000159778100f, 0.000000000000f},
    {0.000411511700f, 0.000148604400f, 0.000000000000f},
    {0.000382981400f, 0.000138301600f, 0.000000000000f},
    {0.000356649100f, 0.000128792500f, 0.000000000000f},
    {0.000332301100f, 0.000120000000f, 0.000000000000f},
    {0.000309758600f, 0.000111859500f, 0.000000000000f},
    {0.000288887100f, 0.000104322400f, 0.000000000000f},
    {0.000269539400f, 0.000097335600f, 0.000000000000f},
    {0.000251568200f, 0.000090845870f, 0.000000000000f},
    {0.000234826100f, 0.000084800000f, 0.000000000000f},
    {0.000219171000f, 0.000079146670f, 0.000000000000f},
    {0.000204525800f, 0.000073858000f, 0.000000000000f},
    {0.000190840500f, 0.000068916000f, 0.000000000000f},
    {0.000178065400f, 0.000064302670f, 0.000000000000f},
    {0.000166150500f, 0.000060000000f, 0.000000000000f},
    {0.000155023600f, 0.000055981870f, 0.000000000000f},
    {0.000144621900f, 0.000052225600f, 0.000000000000f},
    {0.000134909800f, 0.000048718400f, 0.000000000000f},
    {0.000125852000f, 0.000045447470f, 0.000000000000f},
    {0.000117413000f, 0.000042400000f, 0.000000000000f},
    {0.000109551500f, 0.000039561040f, 0.000000000000f},
    {0.000102224500f, 0.000036915120f, 0.000000000000f},
    {0.000095394450f, 0.000034448680f, 0.000000000000f},
    {0.000089023900f, 0.000032148160f, 0.000000000000f},
    {0.000083075270f, 0.000030000000f, 0.000000000000f},
    {0.000077512690f, 0.000027991250f, 0.000000000000f},
    {0.000072313040f, 0.000026113560f, 0.000000000000f},
    {0.000067457780f, 0.000024360240f, 0.000000000000f},
    {0.000062928440f, 0.000022724610f, 0.000000000000f},
    {0.000058706520f, 0.000021200000f, 0.000000000000f},
    {0.000054770280f, 0.000019778550f, 0.000000000000f},
    {0.000051099180f, 0.000018452850f, 0.000000000000f},
    {0.000047676540f, 0.000017216870f, 0.000000000000f},
    {0.000044485670f, 0.000016064590f, 0.000000000000f},
    {0.000041509940f, 0.000014990000f, 0.000000000000f},
    {0.000038733240f, 0.000013987280f, 0.000000000000f},
    {0.000036142030f, 0.000013051550f, 0.000000000000f},
    {0.000033723520f, 0.000012178180f, 0.000000000000f},
    {0.000031464870f, 0.000011362540f, 0.000000000000f},
    {0.000029353260f, 0.000010600000f, 0.000000000000f},
    {0.000027375730f, 0.000009885877f, 0.000000000000f},
    {0.000025524330f, 0.000009217304f, 0.000000000000f},
    {0.000023793760f, 0.000008592362f, 0.000000000000f},
    {0.000022178700f, 0.000008009133f, 0.000000000000f},
    {0.000020673830f, 0.000007465700f, 0.000000000000f},
    {0.000019272260f, 0.000006959567f, 0.000000000000f},
    {0.000017966400f, 0.000006487995f, 0.000000000000f},
    {0.000016749910f, 0.000006048699f, 0.000000000000f},
    {0.000015616480f, 0.000005639396f, 0.000000000000f},
    {0.000014559770f, 0.000005257800f, 0.000000000000f},
    {0.000013573870f, 0.000004901771f, 0.000000000000f},
    {0.000012654360f, 0.000004569720f, 0.000000000000f},
    {0.000011797230f, 0.000004260194f, 0.000000000000f},
    {0.000010998440f, 0.000003971739f, 0.000000000000f},
    {0.000010253980f, 0.000003702900f, 0.000000000000f},
    {0.000009559646f, 0.000003452163f, 0.000000000000f},
    {0.000008912044f, 0.000003218302f, 0.000000000000f},
    {0.000008308358f, 0.000003000300f, 0.000000000000f},
    {0.000007745769f, 0.000002797139f, 0.000000000000f},
    {0.000007221456f, 0.000002607800f, 0.000000000000f},
    {0.000006732475f, 0.000002431220f, 0.000000000000f},
    {0.000006276423f, 0.000002266531f, 0.000000000000f},
    {0.000005851304f, 0.000002113013f, 0.000000000000f},
    {0.000005455118f, 0.000001969943f, 0.000000000000f},
    {0.000005085868f, 0.000001836600f, 0.000000000000f},
    {0.000004741466f, 0.000001712230f, 0.000000000000f},
    {0.000004420236f, 0.000001596228f, 0.000000000000f},
    {0.000004120783f, 0.000001488090f, 0.000000000000f},
    {0.000003841716f, 0.000001387314f, 0.000000000000f},
    {0.000003581652f, 0.000001293400f, 0.000000000000f},
    {0.000003339127f, 0.000001205820f, 0.000000000000f},
    {0.000003112949f, 0.000001124143f, 0.000000000000f},
    {0.000002902121f, 0.000001048009f, 0.000000000000f},
    {0.000002705645f, 0.000000977058f, 0.000000000000f},
    {0.000002522525f, 0.000000910930f, 0.000000000000f},
    {0.000002351726f, 0.000000849251f, 0.000000000000f},
    {0.000002192415f, 0.000000791721f, 0.000000000000f},
    {0.000002043902f, 0.000000738090f, 0.000000000000f},
    {0.000001905497f, 0.000000688110f, 0.000000000000f},
    {0.000001776509f, 0.000000641530f, 0.000000000000f},
    {0.000001656215f, 0.000000598090f, 0.000000000000f},
    {0.000001544022f, 0.000000557575f, 0.000000000000f},
    {0.000001439440f, 0.000000519808f, 0.000000000000f},
    {0.000001341977f, 0.000000484612f, 0.000000000000f},
    {0.000001251141f, 0.000000451810f, 0.000000000000f}};

/* Rec.709 RGB to wavelength intensities LUT. Range 360 - 830, step 1.
 * http://scottburns.us/fast-rgb-to-spectrum-conversion-for-reflectances/ */
ccl_static_constant float rec709_wavelength_lookup[][3] = {
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028818291f, 0.011877002f, 0.959304707f},
    {0.028818291f, 0.011877002f, 0.959304707f}, {0.028811021f, 0.011877002f, 0.959311977f},
    {0.028802781f, 0.011877002f, 0.959320217f}, {0.028793521f, 0.011877002f, 0.959329477f},
    {0.02878296f, 0.011877002f, 0.959340038f},  {0.028770917f, 0.011877002f, 0.95935208f},
    {0.028757342f, 0.011877002f, 0.959365656f}, {0.028741827f, 0.011877002f, 0.959381171f},
    {0.02872419f, 0.011877002f, 0.959398808f},  {0.028704048f, 0.011877002f, 0.95941895f},
    {0.028681031f, 0.011886657f, 0.959432313f}, {0.02865476f, 0.011897721f, 0.959447519f},
    {0.028624766f, 0.011910316f, 0.959464919f}, {0.028590487f, 0.0119247f, 0.959484814f},
    {0.028551637f, 0.011941085f, 0.959507279f}, {0.028507641f, 0.011959757f, 0.959532602f},
    {0.028457679f, 0.011980956f, 0.959561366f}, {0.028401308f, 0.012005032f, 0.959593661f},
    {0.028337507f, 0.012032367f, 0.959630128f}, {0.028265518f, 0.012063369f, 0.959671114f},
    {0.028184712f, 0.012098436f, 0.959716853f}, {0.028093938f, 0.012138183f, 0.959767881f},
    {0.027992225f, 0.01218309f, 0.959824687f},  {0.027878758f, 0.012233713f, 0.959887532f},
    {0.027752728f, 0.012290715f, 0.95995656f},  {0.027613202f, 0.012354682f, 0.960032118f},
    {0.027459639f, 0.012426334f, 0.96011403f},  {0.027291406f, 0.012506237f, 0.96020236f},
    {0.027108029f, 0.012595103f, 0.960296871f}, {0.026909351f, 0.01269359f, 0.960397062f},
    {0.026695068f, 0.012802303f, 0.960502632f}, {0.026465327f, 0.012922024f, 0.960612653f},
    {0.02621978f, 0.013053697f, 0.960726528f},  {0.02595819f, 0.013198476f, 0.960843339f},
    {0.025680593f, 0.013357408f, 0.960962004f}, {0.025387006f, 0.013531737f, 0.961081261f},
    {0.02507752f, 0.013722843f, 0.961199642f},  {0.024752635f, 0.013932033f, 0.961315337f},
    {0.024412905f, 0.014160874f, 0.961426226f}, {0.02405883f, 0.014411037f, 0.961530138f},
    {0.023691176f, 0.014684282f, 0.961624548f}, {0.02331084f, 0.014982637f, 0.961706529f},
    {0.022918745f, 0.015308115f, 0.961773146f}, {0.02251608f, 0.015663026f, 0.9618209f},
    {0.022103926f, 0.016049824f, 0.961846257f}, {0.021683511f, 0.016471404f, 0.961845091f},
    {0.021256027f, 0.016930724f, 0.961813257f}, {0.020822729f, 0.017431474f, 0.961745804f},
    {0.020384772f, 0.017977408f, 0.961637827f}, {0.019943276f, 0.01857313f, 0.961483602f},
    {0.019499471f, 0.019223505f, 0.961277031f}, {0.019054471f, 0.019934375f, 0.961011161f},
    {0.018609424f, 0.020711793f, 0.960678791f}, {0.018165471f, 0.021562842f, 0.960271695f},
    {0.017723519f, 0.022495442f, 0.959781047f}, {0.017284601f, 0.02351872f, 0.959196687f},
    {0.016849621f, 0.024643089f, 0.958507298f}, {0.016419409f, 0.025880449f, 0.957700149f},
    {0.015994666f, 0.027244468f, 0.956760874f}, {0.015576139f, 0.028750929f, 0.95567294f},
    {0.015164369f, 0.030417962f, 0.954417677f}, {0.014759893f, 0.03226665f, 0.952973465f},
    {0.01436327f, 0.034321187f, 0.951315551f},  {0.013974834f, 0.036609597f, 0.949415576f},
    {0.013594951f, 0.039164589f, 0.947240469f}, {0.01322398f, 0.042024179f, 0.944751849f},
    {0.012862081f, 0.045232687f, 0.94190524f},  {0.012509509f, 0.048841513f, 0.938648986f},
    {0.012166415f, 0.052910539f, 0.934923054f}, {0.011832836f, 0.05750968f, 0.930657491f},
    {0.011508938f, 0.062721079f, 0.925769991f}, {0.011194664f, 0.068641244f, 0.9201641f},
    {0.010890006f, 0.075385301f, 0.913724701f}, {0.010594921f, 0.083088729f, 0.906316358f},
    {0.010309243f, 0.091912392f, 0.897778373f}, {0.010032852f, 0.102044876f, 0.887922279f},
    {0.00976562f, 0.113708114f, 0.876526273f},  {0.009507356f, 0.127159828f, 0.863332823f},
    {0.009257866f, 0.14269643f, 0.848045711f},  {0.0090169f, 0.160651591f, 0.830331517f},
    {0.008784129f, 0.181390517f, 0.809825361f}, {0.008559389f, 0.205290227f, 0.786150391f},
    {0.008342333f, 0.232698734f, 0.75895894f},  {0.008132602f, 0.263880897f, 0.727986508f},
    {0.007929888f, 0.298929894f, 0.693140225f}, {0.007733877f, 0.337660526f, 0.654605604f},
    {0.007544324f, 0.379519416f, 0.612936267f}, {0.007361023f, 0.423563429f, 0.569075555f},
    {0.007183855f, 0.468553426f, 0.524262725f}, {0.007012745f, 0.513160591f, 0.479826671f},
    {0.006847712f, 0.556197975f, 0.436954319f}, {0.006688746f, 0.596774501f, 0.39653676f},
    {0.006535881f, 0.634336924f, 0.359127201f}, {0.006389133f, 0.668637252f, 0.324973622f},
    {0.006248471f, 0.699655061f, 0.294096474f}, {0.006113831f, 0.727519207f, 0.266366969f},
    {0.00598516f, 0.752443966f, 0.24157088f},   {0.005862418f, 0.774683948f, 0.219453641f},
    {0.005745439f, 0.794504131f, 0.199750437f}, {0.005634161f, 0.812162229f, 0.182203618f},
    {0.005528477f, 0.827899667f, 0.166571863f}, {0.005428285f, 0.841936088f, 0.152635634f},
    {0.0053335f, 0.854469313f, 0.140197194f},   {0.005244008f, 0.865675487f, 0.129080512f},
    {0.005159746f, 0.875710212f, 0.11913005f},  {0.00508063f, 0.88471046f, 0.110208918f},
    {0.005006586f, 0.892796076f, 0.102197347f}, {0.004937545f, 0.900072521f, 0.094989942f},
    {0.00487342f, 0.906632179f, 0.08849441f},   {0.004814165f, 0.912555819f, 0.082630025f},
    {0.004759755f, 0.917913767f, 0.077326487f}, {0.004710142f, 0.922768547f, 0.07252132f},
    {0.004665292f, 0.92717411f, 0.068160607f},  {0.004625163f, 0.931178591f, 0.064196255f},
    {0.004589756f, 0.934823889f, 0.060586364f}, {0.004559076f, 0.938146992f, 0.057293941f},
    {0.004533115f, 0.941180584f, 0.05428631f},  {0.004511878f, 0.943953492f, 0.05153464f},
    {0.004495412f, 0.9464914f, 0.049013197f},   {0.004483749f, 0.948816965f, 0.046699295f},
    {0.004476933f, 0.950950467f, 0.044572609f}, {0.004475011f, 0.952909752f, 0.042615247f},
    {0.004478088f, 0.954710433f, 0.040811489f}, {0.004486263f, 0.956366386f, 0.039147361f},
    {0.00449967f, 0.957890048f, 0.037610292f},  {0.004518465f, 0.959292655f, 0.036188889f},
    {0.004542805f, 0.960584215f, 0.03487299f},  {0.00457288f, 0.961773573f, 0.033653556f},
    {0.004608895f, 0.962868623f, 0.032522492f}, {0.00465109f, 0.963876448f, 0.031472471f},
    {0.004699746f, 0.96480335f, 0.030496912f},  {0.004755186f, 0.965655044f, 0.029589778f},
    {0.004817721f, 0.966436842f, 0.028745446f}, {0.004887673f, 0.967153428f, 0.027958907f},
    {0.004965447f, 0.967808972f, 0.02722559f},  {0.005051466f, 0.968407165f, 0.026541377f},
    {0.005146221f, 0.968951191f, 0.025902595f}, {0.005250261f, 0.969443961f, 0.025305785f},
    {0.005364196f, 0.969887939f, 0.024747872f}, {0.005488688f, 0.970285274f, 0.024226044f},
    {0.005624523f, 0.970637837f, 0.023737647f}, {0.005772524f, 0.970947128f, 0.023280354f},
    {0.005933641f, 0.971214249f, 0.022852116f}, {0.006108994f, 0.971440082f, 0.02245093f},
    {0.006299756f, 0.971625195f, 0.022075054f}, {0.006507247f, 0.971769994f, 0.021722764f},
    {0.006733051f, 0.971874423f, 0.021392531f}, {0.006978854f, 0.9719382f, 0.02108295f},
    {0.007246538f, 0.971960799f, 0.020792667f}, {0.00753827f, 0.971941249f, 0.020520485f},
    {0.007856514f, 0.971878264f, 0.020265225f}, {0.008204064f, 0.971770126f, 0.020025813f},
    {0.008583947f, 0.971614816f, 0.019801239f}, {0.008999675f, 0.971409878f, 0.019590449f},
    {0.009455237f, 0.971152241f, 0.019392523f}, {0.009955215f, 0.970838189f, 0.019206597f},
    {0.010504749f, 0.970463452f, 0.0190318f},   {0.011109803f, 0.970022766f, 0.018867431f},
    {0.011777308f, 0.969510027f, 0.018712665f}, {0.012515126f, 0.968918048f, 0.018566825f},
    {0.013332373f, 0.96823842f, 0.018429206f},  {0.014239681f, 0.967461152f, 0.018299166f},
    {0.015249411f, 0.966574582f, 0.018176005f}, {0.016375927f, 0.965564859f, 0.018059211f},
    {0.017636162f, 0.96441567f, 0.017948165f},  {0.019050053f, 0.963107683f, 0.017842261f},
    {0.02064098f, 0.961618056f, 0.01774096f},   {0.022436706f, 0.959919497f, 0.017643792f},
    {0.024470247f, 0.957979541f, 0.017550207f}, {0.026781156f, 0.955759173f, 0.017459665f},
    {0.029416764f, 0.953211636f, 0.017371594f}, {0.032434165f, 0.95028025f, 0.017285579f},
    {0.03590266f, 0.946896161f, 0.017201171f},  {0.03990671f, 0.942975375f, 0.017117908f},
    {0.044549637f, 0.938415042f, 0.017035312f}, {0.049957946f, 0.9330891f, 0.016952945f},
    {0.056288019f, 0.926841641f, 0.016870331f}, {0.063732852f, 0.919480119f, 0.01678702f},
    {0.072532236f, 0.910765162f, 0.016702592f}, {0.08298439f, 0.900398982f, 0.016616618f},
    {0.09546049f, 0.888010848f, 0.016528651f},  {0.11042104f, 0.873140755f, 0.016438193f},
    {0.128430384f, 0.855224817f, 0.016344788f}, {0.150174712f, 0.833577319f, 0.016247957f},
    {0.17646848f, 0.807384293f, 0.016147214f},  {0.208235667f, 0.775722345f, 0.016041975f},
    {0.246440024f, 0.737628435f, 0.015931528f}, {0.291908018f, 0.692276903f, 0.015815065f},
    {0.344984668f, 0.639323614f, 0.015691704f}, {0.405003302f, 0.579436097f, 0.015560587f},
    {0.469770292f, 0.51480865f, 0.015421044f},  {0.535622243f, 0.44910473f, 0.015273012f},
    {0.598446474f, 0.386436255f, 0.015117256f}, {0.655118405f, 0.329926299f, 0.014955281f},
    {0.704188549f, 0.281022574f, 0.014788861f}, {0.745606932f, 0.239773366f, 0.014619686f},
    {0.780098645f, 0.205452132f, 0.014449208f}, {0.808669226f, 0.177052183f, 0.014278574f},
    {0.832329195f, 0.153562082f, 0.014108706f}, {0.85197346f, 0.134086206f, 0.013940317f},
    {0.868355627f, 0.117870335f, 0.013774022f}, {0.882088371f, 0.104301317f, 0.013610295f},
    {0.893665842f, 0.092884622f, 0.013449518f}, {0.903484049f, 0.083223919f, 0.013292015f},
    {0.911858005f, 0.075003924f, 0.013138054f}, {0.91904131f, 0.067970837f, 0.012987836f},
    {0.925236892f, 0.061921566f, 0.012841525f}, {0.930609071f, 0.056691665f, 0.012699247f},
    {0.935290842f, 0.052148021f, 0.01256112f},  {0.939390513f, 0.048182279f, 0.012427191f},
    {0.942996767f, 0.044705727f, 0.012297489f}, {0.946182355f, 0.041645556f, 0.012172072f},
    {0.949008025f, 0.038941093f, 0.012050866f}, {0.951523919f, 0.036542201f, 0.011933864f},
    {0.953772082f, 0.034406857f, 0.011821045f}, {0.955787697f, 0.032499914f, 0.011712372f},
    {0.957600446f, 0.030791764f, 0.011607774f}, {0.959235683f, 0.029257157f, 0.011507144f},
    {0.960714776f, 0.02787477f, 0.011410438f},  {0.962055945f, 0.026626454f, 0.011317586f},
    {0.963275107f, 0.02549641f, 0.011228468f},  {0.964300437f, 0.02447108f, 0.011228468f},
    {0.9652328f, 0.023538717f, 0.011228468f},   {0.966082492f, 0.022689026f, 0.011228468f},
    {0.966858432f, 0.021913087f, 0.011228468f}, {0.967568415f, 0.021203103f, 0.011228468f},
    {0.968219303f, 0.020552216f, 0.011228468f}, {0.968817046f, 0.019954474f, 0.011228468f},
    {0.969366905f, 0.019404615f, 0.011228468f}, {0.969873478f, 0.018898043f, 0.011228468f},
    {0.970340909f, 0.018430612f, 0.011228468f}, {0.970772869f, 0.017998652f, 0.011228468f},
    {0.971172383f, 0.017599138f, 0.011228468f}, {0.97154218f, 0.017229342f, 0.011228468f},
    {0.971884776f, 0.016886746f, 0.011228468f}, {0.972202337f, 0.016569185f, 0.011228468f},
    {0.97249689f, 0.016274633f, 0.011228468f},  {0.972770257f, 0.016001266f, 0.011228468f},
    {0.973023999f, 0.015747524f, 0.011228468f}, {0.973259632f, 0.015511892f, 0.011228468f},
    {0.973478536f, 0.015292988f, 0.011228468f}, {0.973681941f, 0.015089583f, 0.011228468f},
    {0.973870951f, 0.014900573f, 0.011228468f}, {0.974046776f, 0.014724748f, 0.011228468f},
    {0.974210313f, 0.014561212f, 0.011228468f}, {0.974362517f, 0.014409008f, 0.011228468f},
    {0.974504245f, 0.014267281f, 0.011228468f}, {0.974636162f, 0.014135364f, 0.011228468f},
    {0.97475915f, 0.014012377f, 0.011228468f},  {0.97487371f, 0.013897817f, 0.011228468f},
    {0.974980528f, 0.013790999f, 0.011228468f}, {0.975080171f, 0.013691356f, 0.011228468f},
    {0.975173072f, 0.013598455f, 0.011228468f}, {0.975259696f, 0.013511832f, 0.011228468f},
    {0.97534048f, 0.013431048f, 0.011228468f},  {0.975415806f, 0.013355721f, 0.011228468f},
    {0.975486006f, 0.013285522f, 0.011228468f}, {0.975551437f, 0.013220092f, 0.011228468f},
    {0.975612438f, 0.01315909f, 0.011228468f},  {0.975669295f, 0.013102234f, 0.011228468f},
    {0.975722246f, 0.013049283f, 0.011228468f}, {0.97577158f, 0.012999949f, 0.011228468f},
    {0.97581754f, 0.012953989f, 0.011228468f},  {0.97586035f, 0.012911179f, 0.011228468f},
    {0.97590022f, 0.01287131f, 0.011228468f},   {0.975937277f, 0.012834253f, 0.011228468f},
    {0.975971818f, 0.012799711f, 0.011228468f}, {0.976003931f, 0.012767598f, 0.011228468f},
    {0.976033845f, 0.012737685f, 0.011228468f}, {0.976061665f, 0.012709865f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f},  {0.976087481f, 0.01268405f, 0.011228468f},
    {0.976087481f, 0.01268405f, 0.011228468f}};

ccl_device float3 xyz_to_rgb(const KernelGlobals *kg, float3 xyz)
{
  return make_float3(dot(float4_to_float3(kernel_data.film.xyz_to_r), xyz),
                     dot(float4_to_float3(kernel_data.film.xyz_to_g), xyz),
                     dot(float4_to_float3(kernel_data.film.xyz_to_b), xyz));
}

ccl_device float linear_rgb_to_gray(const KernelGlobals *kg, float3 c)
{
  return dot(c, float4_to_float3(kernel_data.film.rgb_to_y));
}

ccl_device float3 find_position_in_lookup_unit_step(
    ccl_constant float lookup[][3], float position_to_find, int start, int end, int step)
{
  if (UNLIKELY(position_to_find <= start)) {
    return load_float3(lookup[0]);
  }
  if (UNLIKELY(position_to_find >= end)) {
    int i = (end - start) / step;
    return load_float3(lookup[i]);
  }

  float lookup_pos = (position_to_find - start) / (float)step;
  int lower_bound = floor_to_int(lookup_pos);
  int upper_bound = min(lower_bound + 1, (end - start) / step);
  float progress = lookup_pos - int(lookup_pos);
  return mix(load_float3(lookup[lower_bound]), load_float3(lookup[upper_bound]), progress);
}

ccl_device float find_position_in_lookup_unit_step(
    ccl_constant float lookup[], float position_to_find, int start, int end, int step)
{
  if (UNLIKELY(position_to_find <= start)) {
    return lookup[0];
  }
  if (UNLIKELY(position_to_find >= end)) {
    int i = (end - start) / step;
    return lookup[i];
  }

  float lookup_pos = (position_to_find - start) / (float)step;
  int lower_bound = floor_to_int(lookup_pos);
  int upper_bound = min(lower_bound + 1, (end - start) / step);
  float progress = lookup_pos - int(lookup_pos);
  return mix(lookup[lower_bound], lookup[upper_bound], progress);
}

ccl_device float3 wavelength_to_xyz(const KernelGlobals *kg, float wavelength)
{
  // int table_offset = kernel_data.cam.camera_response_function_table_offset;

  // float position = lerp(0.0f,
  //                       WAVELENGTH_CDF_TABLE_SIZE - 1.0f,
  //                       inverse_lerp(MIN_WAVELENGTH, MAX_WAVELENGTH, wavelength));

  // int lower_bound = floor_to_int(position);
  // int upper_bound = min(lower_bound + 1, WAVELENGTH_CDF_TABLE_SIZE - 1);
  // float progress = position - lower_bound;

  // float3 lower_value = make_float3(
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * lower_bound + 0),
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * lower_bound + 1),
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * lower_bound + 2));
  // float3 upper_value = make_float3(
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * upper_bound + 0),
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * upper_bound + 1),
  //     kernel_tex_fetch(__lookup_table, table_offset + 3 * upper_bound + 2));

  // return lerp(lower_value, upper_value, progress);

  return find_position_in_lookup_unit_step(wavelength_xyz_lookup, wavelength, 360, 830, 1);
}

ccl_device float3 spectrum_to_rgb(INTEGRATOR_STATE_CONST_ARGS, SpectralColor intensities)
{
#ifndef __SPECTRAL_RENDERING__
  return intensities;
#else
  const SpectralColor &wavelengths = INTEGRATOR_STATE(ray, wavelengths);

  float3 xyz_sum = zero_float3();
  FOREACH_CHANNEL (i) {
    xyz_sum += wavelength_to_xyz(kg, GET_CHANNEL(wavelengths, i)) * GET_CHANNEL(intensities, i);
  }

  xyz_sum *= 3.0f / CHANNELS_PER_RAY;

  return xyz_to_rgb(kg, xyz_sum);
#endif
}

ccl_device SpectralColor rgb_to_spectrum(INTEGRATOR_STATE_CONST_ARGS, float3 rgb)
{
#ifndef __SPECTRAL_RENDERING__
  return rgb;
#else
  const SpectralColor &wavelengths = INTEGRATOR_STATE(ray, wavelengths);

  SpectralColor intensities;
  FOREACH_CHANNEL (i) {
    /* Find position in the lookup of wavelength. */
    float3 magnitudes = find_position_in_lookup_unit_step(
        rec709_wavelength_lookup, GET_CHANNEL(wavelengths, i), 360, 830, 1);
    /* Multiply the lookups by the RGB factors. */
    float3 contributions = magnitudes * rgb;
    /* Add the three components. */
    GET_CHANNEL(intensities, i) = reduce_add_f(contributions);
  }

  return intensities;
#endif
}

ccl_device float spectrum_to_gray(INTEGRATOR_STATE_CONST_ARGS, SpectralColor c)
{
  return dot(spectrum_to_rgb(INTEGRATOR_STATE_PASS, c),
             float4_to_float3(kernel_data.film.rgb_to_y));
}

CCL_NAMESPACE_END
